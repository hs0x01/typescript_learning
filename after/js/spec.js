function observable(e){return ko.isObservable(e)?e:ko.observable(e)}function observableArray(e){if(!Array.isArray(e))throw new Error("An argument is not Array.");return ko.isObservable(e)?e:ko.observableArray(e)}var BaseModel=function(){function e(e){this._id=observable(e||"")}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e},enumerable:!0,configurable:!0}),e}(),__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},DepartmentListModel=function(e){function t(t,n){e.call(this,t),this._departmentModelList=observableArray(n||[])}return __extends(t,e),Object.defineProperty(t.prototype,"departmentModelList",{get:function(){return this._departmentModelList},set:function(e){this._departmentModelList=e},enumerable:!0,configurable:!0}),t.prototype.findEmployeeByArgs=function(e,t,n){for(var o=[],i=this.departmentModelList(),l=0;l<i.length;l++)for(var r=i[l],d=r.employeeListModel(),p=d.employeeModelList(),s=0;s<p.length;s++){var a=p[s];e&&e!==a.id()||t&&a.name().indexOf(t)<0||n&&n!==a.departmentModel().id()||o.push(a)}return o},t.prototype.findDepartmentById=function(e){for(var t=this.departmentModelList(),n=0;n<t.length;n++){var o=t[n];if(e===o.id())return o}return null},t}(BaseModel),DepartmentModel=function(e){function t(t,n,o){e.call(this,t),this._name=observable(n||""),this._employeeListModel=observable(o||null)}return __extends(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"employeeListModel",{get:function(){return this._employeeListModel},set:function(e){this._employeeListModel=e},enumerable:!0,configurable:!0}),t.prototype.addEmployee=function(e,t){var n=new EmployeeModel(e,t,this);this.employeeListModel().employeeModelList.push(n)},t.prototype.deleteEmployee=function(e){for(var t=this.employeeListModel().employeeModelList(),n=0;n<t.length;n++){var o=t[n];o.id()===e&&this.employeeListModel().employeeModelList.splice(n,1)}},t}(BaseModel),EmployeeListModel=function(e){function t(t,n){e.call(this,t),this._employeeModelList=observableArray(n||[])}return __extends(t,e),Object.defineProperty(t.prototype,"employeeModelList",{get:function(){return this._employeeModelList},set:function(e){this._employeeModelList=e},enumerable:!0,configurable:!0}),t}(BaseModel),EmployeeModel=function(e){function t(t,n,o){e.call(this,t),this._name=observable(n||""),this._departmentModel=observable(o||null)}return __extends(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"departmentModel",{get:function(){return this._departmentModel},set:function(e){this._departmentModel=e},enumerable:!0,configurable:!0}),t.prototype.updateEmployeeInfo=function(e,t){if(this.name(e),this.departmentModel().id()!==t.id()){for(var n=this.departmentModel().employeeListModel().employeeModelList,o=0;o<n().length;o++){var i=n()[o];if(i.id()===this.id()){n().splice(o,1);break}}t.employeeListModel().employeeModelList.push(this),this.departmentModel(t)}},t}(BaseModel),DepartmentRepository=function(){function e(){}return e.findDepartmentAll=function(e){var t=null,n=localStorage.getItem(this.LOCAL_STORAGE_KEY);t=null===n?this.createDepartmentListModelFromDefault():this.createDepartmentListModelFromXml(n),e(t)},e.saveDepartmentAll=function(e,t){var n=this.createDepartmentListModelXml(e);localStorage.setItem(this.LOCAL_STORAGE_KEY,n),t()},e.createDepartmentListModelXml=function(e){var t='<?xml version="1.0" encoding="UTF-8"?>';t+="    <departmentListModel>",t+="        <id>"+e.id()+"</id>";for(var n=e.departmentModelList(),o=0;o<n.length;o++){var i=n[o];t+="    <departmentModel>",t+="        <id>"+i.id()+"</id>",t+="        <name>"+i.name()+"</name>",t+="        <employeeListModel>";var l=i.employeeListModel();t+="            <id>"+l.id()+"</id>";for(var r=l.employeeModelList(),d=0;d<r.length;d++){var p=r[d];t+="        <employeeModel>",t+="            <id>"+p.id()+"</id>",t+="            <name>"+p.name()+"</name>",t+="        </employeeModel>"}t+="        </employeeListModel>",t+="    </departmentModel>"}return t+="    </departmentListModel>"},e.createDepartmentListModelFromDefault=function(){var e=new EmployeeListModel(GuidUtil.createGuid(),[]),t=new EmployeeListModel(GuidUtil.createGuid(),[]),n=new EmployeeListModel(GuidUtil.createGuid(),[]),o=new DepartmentModel(GuidUtil.createGuid(),"開発部",e),i=new DepartmentModel(GuidUtil.createGuid(),"営業部",t),l=new DepartmentModel(GuidUtil.createGuid(),"総務部",n),r=[];r.push(o),r.push(i),r.push(l);var d=new DepartmentListModel(GuidUtil.createGuid(),r);return d},e.createDepartmentListModelFromXml=function(e){var t=$($.parseXML(e)),n=t.find("departmentListModel"),o=n.children("id").text(),i=new DepartmentListModel(o,[]),l=n.find("departmentModel");return l.each(function(){var e=$(this),t=e.children("id").text(),n=e.children("name").text(),o=e.find("employeeListModel"),l=o.children("id").text(),r=new DepartmentModel(t,n,new EmployeeListModel(l,[]));i.departmentModelList.push(r);var d=o.find("employeeModel");d.each(function(){var e=$(this),t=e.children("id").text(),n=e.children("name").text();r.addEmployee(t,n)})}),i},e.LOCAL_STORAGE_KEY="sample.all-department-model",e}(),GuidUtil=function(){function e(){}return e.createGuid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e}(),EmployeeCrudViewModel=function(){function e(e){this._employeeId=observable(""),this._employeeName=observable(""),this._department=observable(null),this._employeeIdFind=observable(""),this._employeeNameFind=observable(""),this._departmentFind=observable(null),this._departmentListModel=observable(null),this._employeeListViewModel=new EmployeeListViewModel,this.resetInput=function(){this.employeeId(""),this.employeeName(""),this.department(null),this.employeeIdFind(""),this.employeeNameFind(""),this.departmentFind(null)};var t=this;this._employeeIdFind.subscribe(function(){t.findEmployee()}),this._employeeNameFind.subscribe(function(){t.findEmployee()}),this._departmentFind.subscribe(function(){t.findEmployee()}),DepartmentRepository.findDepartmentAll(function(n){t._departmentListModel(n),e(t)})}return Object.defineProperty(e.prototype,"employeeId",{get:function(){return this._employeeId},set:function(e){this._employeeId=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"employeeName",{get:function(){return this._employeeName},set:function(e){this._employeeName=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"department",{get:function(){return this._department},set:function(e){this._department=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"employeeIdFind",{get:function(){return this._employeeIdFind},set:function(e){this._employeeIdFind=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"employeeNameFind",{get:function(){return this._employeeNameFind},set:function(e){this._employeeNameFind=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"departmentFind",{get:function(){return this._departmentFind},set:function(e){this._departmentFind=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"departmentListModel",{get:function(){return this._departmentListModel},set:function(e){this._departmentListModel=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"employeeListViewModel",{get:function(){return this._employeeListViewModel},set:function(e){this._employeeListViewModel=e},enumerable:!0,configurable:!0}),e.prototype.findEmployee=function(){var e=this.departmentListModel().findEmployeeByArgs(this.employeeIdFind(),this.employeeNameFind(),this.departmentFind()?this.departmentFind().id():null),t=this.employeeListViewModel.employeeListModel().employeeModelList;t(e)},e.prototype.selectEmployee=function(){var e=this.employeeListViewModel.getSelectedEmployee();this.employeeId(e.id()),this.employeeName(e.name()),this.department(e.departmentModel())},e.prototype.canAddEmployee=function(){if(!this.employeeId())return!1;if(!this.employeeName())return!1;if(!this.department()||!this.department().id())return!1;var e=this.departmentListModel().findEmployeeByArgs(this.employeeId(),null,null);return e.length>0?!1:!0},e.prototype.canUpdateEmployee=function(){if(!this.employeeId())return!1;if(!this.employeeName())return!1;if(!this.department()||!this.department().id())return!1;var e=this.departmentListModel().findEmployeeByArgs(this.employeeId(),null,null);return 0===e.length?!1:!0},e.prototype.canDeleteEmployee=function(){if(!this.employeeId())return!1;var e=this.departmentListModel().findEmployeeByArgs(this.employeeId(),null,null);return 0===e.length?!1:!0},e.prototype.addEmployee=function(){if(this.canAddEmployee()){var e=this.departmentListModel().findDepartmentById(this.department().id());e.addEmployee(this.employeeId(),this.employeeName()),this.resetInput(),this.findEmployee()}},e.prototype.updateEmployee=function(){if(this.canUpdateEmployee()){var e=this.departmentListModel().findEmployeeByArgs(this.employeeId(),null,null),t=e[0];t.updateEmployeeInfo(this.employeeName(),this.department()),this.resetInput(),this.findEmployee()}},e.prototype.deleteEmployee=function(){if(this.canDeleteEmployee()){var e=this.departmentListModel().findEmployeeByArgs(this.employeeId(),null,null),t=e[0];t.departmentModel().deleteEmployee(this.employeeId()),this.resetInput(),this.findEmployee()}},e.prototype.saveDepartmentAll=function(){DepartmentRepository.saveDepartmentAll(this.departmentListModel(),function(){})},e}(),EmployeeListViewModel=function(){function e(){this._selectedRowIdx=observable(0),this._employeeListModel=observable(new EmployeeListModel(GuidUtil.createGuid(),[]))}return Object.defineProperty(e.prototype,"selectedRowIdx",{get:function(){return this._selectedRowIdx},set:function(e){this._selectedRowIdx=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"employeeListModel",{get:function(){return this._employeeListModel},set:function(e){this._employeeListModel=e},enumerable:!0,configurable:!0}),e.prototype.getSelectedEmployee=function(){var e=this.employeeListModel(),t=e.employeeModelList(),n=null;return this.selectedRowIdx()>=0&&this.selectedRowIdx()<t.length&&(n=e.employeeModelList()[this.selectedRowIdx()]),n},e}();describe("部署モデル",function(){var e=null;beforeEach(function(){var t=[],n=new EmployeeListModel("1",t);e=new DepartmentModel("1","システム開発部",n)}),describe("社員を部署に追加する",function(){it("社員IDと社員名を指定すると、社員が部署に追加される",function(){e.addEmployee("1","テスト　太郎");var t=e.employeeListModel().employeeModelList();expect(t.length).toBe(1);var n=t[0];expect(n.id()).toBe("1"),expect(n.name()).toBe("テスト　太郎"),expect(n.departmentModel()).toBe(e)})}),describe("社員を部署から削除する",function(){it("指定した社員IDの社員が削除される",function(){e.addEmployee("1","テスト　太郎");var t=e.employeeListModel().employeeModelList();expect(t.length).toBe(1),e.deleteEmployee("1"),expect(t.length).toBe(0)}),it("指定した社員IDの社員でなければ、削除されない",function(){e.addEmployee("1","テスト　太郎");var t=e.employeeListModel().employeeModelList();expect(t.length).toBe(1),e.deleteEmployee("2"),expect(t.length).toBe(1)})})}),describe("社員CRUDビューモデル",function(){var e=null;beforeEach(function(t){spyOn(DepartmentRepository,"findDepartmentAll").and.callFake(function(e){var t=[];t.push(new DepartmentModel("d1","システム開発部",new EmployeeListModel("el1",[]))),t.push(new DepartmentModel("d2","営業部",new EmployeeListModel("el2",[])));var n=new DepartmentListModel("dl1",t);e(n)}),new EmployeeCrudViewModel(function(n){e=n,t()})}),describe("すべての部署と所属する社員を保存する",function(){it("すべての部署と所属する社員が、サーバーに保存される",function(){spyOn(DepartmentRepository,"saveDepartmentAll").and.callFake(function(e,t){expect(e.id()).toBe("dl1"),expect(e.departmentModelList().length).toBe(2),t()}),e.saveDepartmentAll()})})});